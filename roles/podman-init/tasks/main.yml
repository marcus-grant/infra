---
# Podman install/config role roles/podman/tasks/main.yml
- name: Ensure podman installed
  ansible.builtin.package:
    name: podman
    state: present

# TODO: Add support for other distros and darwin
- name: Ensure podman dependencies are installed
  ansible.builtin.package:
    name: "{{ podman_init_packages_debian }}"
    state: present
  loop:
    - uidmap
  loop_control:
    loop_var: podman_init_packages_debian
  when: ansible_os_family == 'Debian'

- name: Ensure podman-compose installed
  ansible.builtin.pip:
    name: podman-compose
    state: present
  when: podman_install_compose

# TODO: This can cause problems when registries changes
# It will recreate the line as if the regexp isn't picking up the key
- name: Cofigure podman registries to search in podman_registries list
  ansible.builtin.lineinfile:
    path: /etc/containers/registries.conf
    regexp: '^unqualified-search-registries'
    line: "unqualified-search-registries = [{{ podman_registries | join(', ') }}]"
    owner: root
    group: containers
    mode: 0774
  when:
    - podman_registries is defined
    - podman_registries | length > 0

- name: Ensure group named group for pods or containers exists
  ansible.builtin.group:
    name: "{{ podman_group }}"
    gid: "{{ podman_gid }}"
    state: present

- name: Add any additional groups for podman
  ansible.builtin.group:
    name: "{{ podman_init_extra_groups }}"
    state: present
  loop: "{{ podman_extra_groups }}"
  loop_control:
    loop_var: podman_init_extra_groups
  when:
    - podman_extra_groups is defined
    - podman_extra_groups | length > 0

- name: Add extra users to default general group for all containers
  ansible.builtin.user:
    name: "{{ podman_init_group_users }}"
    groups: "{{ podman_group }}"
    append: true
  loop: "{{ podman_group_users }}"
  loop_control:
    loop_var: podman_init_group_users
  when:
    - podman_group_users is defined
    - podman_group_users | length > 0
